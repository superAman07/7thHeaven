// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(cuid())
  fullName         String
  phone            String    @unique
  otpHash          String?
  email            String?   @unique
  passwordHash     String?
  otpExpiry        DateTime?
  isAdmin          Boolean   @default(false)
  is7thHeaven      Boolean   @default(false)
  referralCode     String?   @unique
  referrerId       String?
  referrer         User?     @relation("Referrals", fields: [referrerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children         User[]    @relation("Referrals")
  lifetimeSpend    Decimal   @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  pincode          String?
  city             String?
  state            String?
  country          String?   @default("India")
  fullAddress      String?
  refreshTokenHash String?
  cart             Cart?
  orders           Order[]
  reviews          Review[]
  wishlist         Wishlist?
}

model Category {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
}

model Product {
  id                 String           @id @default(cuid())
  name               String
  slug               String           @unique
  description        String?
  images             String[]
  genderTags         GenderTags[]
  variants           ProductVariant[]
  inStock            Boolean          @default(true)
  ratingsAvg         Float?
  cartItems          CartItem[]
  reviews            Review[]
  wishlistItems      WishlistItem[]
  createdAt          DateTime         @default(now())
  categoryId         String
  category           Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  isNewArrival       Boolean          @default(false)
  discountPercentage Decimal?         @default(0)
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  text      String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  size      String
  price     Decimal
  sku       String?
  createdAt DateTime @default(now())
}

model Order {
  id                 String    @id @default(cuid())
  userId             String
  user               User      @relation(fields: [userId], references: [id])
  items              Json
  subtotal           Decimal
  discount           Decimal
  netAmountPaid      Decimal
  currency           String    @default("INR")
  couponCode         String?
  paymentStatus      String //<-- enum PENDING / PAID / FAILED / REFUNDED
  status             String    @default("PENDING")
  paymentGateway     String?
  gatewayOrderId     String?
  shippingAddress    Json?
  mlmOptInRequested  Boolean   @default(false)
  mlmEligibleChecked Boolean   @default(false)
  mlmWasEligible     Boolean   @default(false)
  createdAt          DateTime  @default(now())
  Payment            Payment[]
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique // Each cart belongs to one user
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// New Model: Represents an item within a cart
model CartItem {
  id        String  @id @default(cuid())
  quantity  Int
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId]) // A product can only appear once per cart
}

model Coupon {
  id         String    @id @default(cuid())
  code       String    @unique
  type       String // PERCENT / FIXED
  value      Decimal
  expiresAt  DateTime?
  usageLimit Int?
  createdAt  DateTime  @default(now())
}

model Payment {
  id         String   @id @default(cuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id])
  gateway    String
  amount     Decimal
  status     String
  rawPayload Json?
  createdAt  DateTime @default(now())
}

model MLMSettings {
  id                  String   @id @default(cuid())
  eligibilityType     String   @default("single_order") // "single_order" or "lifetime_spend"
  minAmount           Decimal  @default(0)
  minQuantity         Int      @default(0)
  applyAfterDiscount  Boolean  @default(true)
  autoGrantMembership Boolean  @default(true)
  perCategoryRules    Json? // optional map
  createdAt           DateTime @default(now())
}

model MLMAuditLog {
  id        String   @id @default(cuid())
  userId    String?
  event     String // GRANTED / REVOKED / RECOMPUTE
  reason    String?
  meta      Json?
  createdAt DateTime @default(now())
}

model Wishlist {
  id        String         @id @default(cuid())
  userId    String         @unique
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     WishlistItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model WishlistItem {
  id         String   @id @default(cuid())
  wishlistId String
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([wishlistId, productId])
}

enum GenderTags {
  Male
  Female
  Unisex
}
